#!/bin/bash

XMDS_USR=`echo "$BASH_SOURCE" | sed -e 's|/share/xmds/xmds-postinst||'`
XMDS_SUPPORT="${HOME}/Library/XMDS"

mkdir -p ~/.xmds/wisdom

if [ -d "${XMDS_SUPPORT}" ]; then
    chmod -R u+w "${XMDS_SUPPORT}";
    rm -rf "${XMDS_SUPPORT}";
fi

mkdir -p "${XMDS_SUPPORT}"
mkdir -p "${XMDS_USER_DATA}"

echo "Installing virtual python environment..."
/usr/bin/python "${XMDS_USR}/share/xmds/virtualenv.py" --quiet --distribute --never-download --extra-search-dir "${XMDS_USR}/distfiles" "${XMDS_SUPPORT}"

# Use virtual python
source "${XMDS_SUPPORT}/bin/activate"

PYTHON_VERSION=`python -c "import sys;print \"%i.%i\" % sys.version_info[0:2]"`

ln -s /System/Library/Frameworks/Python.framework/Versions/${PYTHON_VERSION}/Extras/lib/python/numpy "${XMDS_SUPPORT}/lib/python${PYTHON_VERSION}/site-packages/numpy"

echo "Installing XMDS2's python dependencies... (this can take a few minutes)"
pip --quiet install "${XMDS_USR}/distfiles/xmds2-requirements.pybundle"

mkdir -p "${XMDS_SUPPORT}/src/xmds2"

echo "Extracting XMDS2..."
tar -xjf "${XMDS_USR}/distfiles/xmds2-svn.tar.bz2" -C "${XMDS_SUPPORT}/src/"
cd "${XMDS_SUPPORT}/src/xmds2"

# Copy in local copy of MathJax
cp -r "${XMDS_USR}/share/xmds/documentation/_static/MathJax" "${XMDS_SUPPORT}/src/xmds2/admin/userdoc-source/_static/"

# Upgrade in case the user has installed a later version of svn
svn upgrade --quiet 2>/dev/null
svn revert --recursive --quiet .

echo "Installing XMDS2..."
make 2>/dev/null
pip install --quiet -e "${XMDS_SUPPORT}/src/xmds2"

chmod -R a-w "${XMDS_SUPPORT}/lib/python${PYTHON_VERSION}/site-packages"

